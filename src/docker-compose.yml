services:
  # --- DATABASES ---
  db_user:
    image: postgres:15-alpine
    container_name: db_user
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: user_db
    ports:
      - "5432:5432" # Expose for local development
    volumes:
      - user_data:/var/lib/postgresql/data

  db_product:
    image: postgres:15-alpine
    container_name: db_product
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: product_db
    ports:
      - "5434:5432" # Expose for local development (different port)
    volumes:
      - product_data:/var/lib/postgresql/data

  db_cart:
    image: postgres:15-alpine
    container_name: db_cart
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: cart_db
    ports:
      - "5435:5432" # Expose for local development
    volumes:
      - cart_data:/var/lib/postgresql/data

  db_order:
    image: postgres:15-alpine
    container_name: db_order
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: order_db
    ports:
      - "5436:5432" # Expose for local development
    volumes:
      - order_data:/var/lib/postgresql/data

  # --- MESSAGE BROKER ---
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: rabbitmq
    hostname: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672" # RabbitMQ Management UI (http://localhost:15672)
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest

  # --- CACHING ---
  redis:
    image: redis:alpine
    container_name: redis
    ports:
      - "6379:6379"

  # --- MICROSERVICES ---
  userservice:
    build:
      context: .. # Build context is the project root
      dockerfile: src/UserService/UserService/Dockerfile
    container_name: userservice
    environment:
      # Connection string uses the internal service name 'db_user'
      ConnectionStrings__DefaultConnection: "Host=db_user;Port=5432;Database=user_db;Username=${POSTGRES_USER};Password=${POSTGRES_PASSWORD}"
      JwtSettings__SecretKey: "${JWT_SECRET}"
      JwtSettings__Issuer: "${JWT_ISSUER}"
      JwtSettings__Audience: "${JWT_AUDIENCE}"
      JwtSettings__TokenLifetimeMinutes: "${JWT_TOKEN_LIFETIME}"
    ports:
      - "5001:8080" # External: 5001, Internal: 8080
    depends_on:
      - db_user

  productcatalogservice:
    build:
      context: ..
      dockerfile: src/ProductCatalogService/ProductCatalogService/Dockerfile
    container_name: productcatalogservice
    environment:
      ConnectionStrings__DefaultConnection: "Host=db_product;Port=5432;Database=product_db;Username=${POSTGRES_USER};Password=${POSTGRES_PASSWORD}"
      ConnectionStrings__Redis: "redis:6379"
      JwtSettings__SecretKey: "${JWT_SECRET}"
      JwtSettings__Issuer: "${JWT_ISSUER}"
      JwtSettings__Audience: "${JWT_AUDIENCE}"
    ports:
      - "5002:8080"
    depends_on:
      - db_product

  shoppingcartservice:
    build:
      context: ..
      dockerfile: src/ShoppingCartService/ShoppingCartService/Dockerfile
    container_name: shoppingcartservice
    environment:
      ConnectionStrings__DefaultConnection: "Host=db_cart;Port=5432;Database=cart_db;Username=${POSTGRES_USER};Password=${POSTGRES_PASSWORD}"
      JwtSettings__SecretKey: "${JWT_SECRET}"
      JwtSettings__Issuer: "${JWT_ISSUER}"
      JwtSettings__Audience: "${JWT_AUDIENCE}"
    ports:
      - "5003:8080" # Assign a new port for direct testing
    depends_on:
      - db_cart
      - productcatalogservice # It needs the product service to run first

  orderservice:
    build:
      context: ..
      dockerfile: src/OrderService/OrderService/Dockerfile
    container_name: orderservice
    environment:
      ConnectionStrings__DefaultConnection: "Host=db_order;Port=5432;Database=order_db;Username=${POSTGRES_USER};Password=${POSTGRES_PASSWORD}"
      JwtSettings__SecretKey: "${JWT_SECRET}"
      JwtSettings__Issuer: "${JWT_ISSUER}"
      JwtSettings__Audience: "${JWT_AUDIENCE}"
    ports:
      - "5004:8080"
    depends_on:
      - db_order
      - shoppingcartservice
      - productcatalogservice # It needs the product service to run first
      - paymentservice
      - rabbitmq

  paymentservice:
    build:
      context: ..
      dockerfile: src/PaymentService/PaymentService/Dockerfile
    container_name: paymentservice
    ports:
      - "5005:8080"

  notificationservice:
    build:
      context: ..
      dockerfile: src/NotificationService/NotificationService/Dockerfile
    container_name: notificationservice
    ports:
      - "5006:8080"
    depends_on:
      - rabbitmq
      - seq

  # --- FRONTEND ---
  webclient:
    build:
      context: ./WebClient
      dockerfile: Dockerfile
    container_name: webclient
    ports:
      - "80:5173"
    environment:
      - API_TARGET=http://apigateway:8080
    depends_on:
      - apigateway

  # --- API GATEWAY ---
  apigateway:
    build:
      context: ..
      dockerfile: src/ApiGateway/ApiGateway/Dockerfile
    container_name: apigateway
    ports:
      - "8080:8080" # The main entry point for API requests (Frontend proxies here)
    depends_on:
      - userservice
      - productcatalogservice

  # --- INFRASTRUCTURE SERVICES --- (Add this block)
  consul:
    image: hashicorp/consul:1.15.5
    container_name: consul
    command: "agent -server -bootstrap-expect=1 -ui -client=0.0.0.0"
    ports:
      - "8500:8500" # Consul UI and HTTP API
      - "8600:8600/udp" # DNS interface

  seq:
    image: datalust/seq:latest
    container_name: seq
    environment:
      # Optional: To persist logs across container restarts
      - ACCEPT_EULA=Y
      - SEQ_FIRSTRUN_NOAUTHENTICATION=true
      - ACCEPT_EULA=Y
    ports:
      - "5341:80" # Seq UI access port (http://localhost:5341)
      - "5342:5341" # Ingestion port for logs
    networks:
      default:
        aliases:
          - seq_server

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml # ⬅️ Configuration file mapping
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
    ports:
      - "9090:9090" # Prometheus UI (http://localhost:9090)
    depends_on:
      - apigateway # Depends on the Gateway for scraping

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000" # Grafana UI (http://localhost:3000)
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    depends_on:
      - prometheus

  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: jaeger
    ports:
      - "16686:16686" # UI
      - "4317:4317" # OTLP gRPC
      - "4318:4318" # OTLP http
    environment:
      - COLLECTOR_OTLP_ENABLED=true

volumes:
  user_data:
  product_data:
  cart_data:
  order_data:
