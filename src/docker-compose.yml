services:
  # --- DATABASES ---
  db_user:
    image: postgres:15-alpine
    container_name: db_user
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: user_db
    ports:
      - "5432:5432" # Expose for local development
    volumes:
      - user_data:/var/lib/postgresql/data

  db_product:
    image: postgres:15-alpine
    container_name: db_product
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: product_db
    ports:
      - "5434:5432" # Expose for local development (different port)
    volumes:
      - product_data:/var/lib/postgresql/data

  db_cart:
    image: postgres:15-alpine
    container_name: db_cart
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: cart_db
    ports:
      - "5435:5432" # Expose for local development
    volumes:
      - cart_data:/var/lib/postgresql/data

  db_order:
    image: postgres:15-alpine
    container_name: db_order
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: order_db
    ports:
      - "5436:5432" # Expose for local development
    volumes:
      - order_data:/var/lib/postgresql/data

  # --- MESSAGE BROKER ---
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: rabbitmq
    hostname: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672" # RabbitMQ Management UI (http://localhost:15672)
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest

  # --- MICROSERVICES ---
  userservice:
    build:
      context: .. # Build context is the project root
      dockerfile: src/UserService/UserService/Dockerfile
    container_name: userservice
    environment:
      # Connection string uses the internal service name 'db_user'
      ConnectionStrings__DefaultConnection: "Host=db_user;Port=5432;Database=user_db;Username=user;Password=password"
    ports:
      - "5001:8080" # External: 5001, Internal: 8080
    depends_on:
      - db_user

  productcatalogservice:
    build:
      context: ..
      dockerfile: src/ProductCatalogService/ProductCatalogService/Dockerfile
    container_name: productcatalogservice
    environment:
      ConnectionStrings__DefaultConnection: "Host=db_product;Port=5432;Database=product_db;Username=user;Password=password"
    ports:
      - "5002:8080"
    depends_on:
      - db_product

  shoppingcartservice:
    build:
      context: ..
      dockerfile: src/ShoppingCartService/ShoppingCartService/Dockerfile
    container_name: shoppingcartservice
    environment:
      ConnectionStrings__DefaultConnection: "Host=db_cart;Port=5432;Database=cart_db;Username=user;Password=password"
    ports:
      - "5003:8080" # Assign a new port for direct testing
    depends_on:
      - db_cart
      - productcatalogservice # It needs the product service to run first

  orderservice:
    build:
      context: ..
      dockerfile: src/OrderService/OrderService/Dockerfile
    container_name: orderservice
    environment:
      ConnectionStrings__DefaultConnection: "Host=db_order;Port=5432;Database=order_db;Username=user;Password=password"
    ports:
      - "5004:8080"
    depends_on:
      - db_order
      - shoppingcartservice
      - productcatalogservice # It needs the product service to run first
      - paymentservice
      - rabbitmq

  paymentservice:
    build:
      context: ..
      dockerfile: src/PaymentService/PaymentService/Dockerfile
    container_name: paymentservice
    ports:
      - "5005:8080"

  # --- API GATEWAY ---
  apigateway:
    build:
      context: ..
      dockerfile: src/ApiGateway/ApiGateway/Dockerfile
    container_name: apigateway
    ports:
      - "80:8080" # The main entry point for client requests
    depends_on:
      - userservice
      - productcatalogservice

volumes:
  user_data:
  product_data:
  cart_data:
  order_data:
